---
title: "Longitudinal Data Analysis Assignment 2"
author: "Andomei Smit: SMTAND051"
date: "01/09/2025"
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 2
    fig_caption: true
    keep_tex: true
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
library(nlme)
library(faraway)
library(lattice)
library(dplyr)
library(ggplot2)
library(tidyr)
library(MuMIn)
```

# Introduction

```{r}
# read in the data
malaria <- read.csv("malariadata.csv")
#head(malaria)

# random sample carefully so that records stay complete
set.seed(1997)
# sample 75% of unique pids
sampled_pids <- malaria %>%
  distinct(pid) %>%
  slice_sample(prop = 0.75) %>%
  pull(pid)

# keep all rows for those pids
malaria <- malaria %>% semi_join(tibble(pid = sampled_pids), by = "pid")

# order malaria by pid
malaria <- malaria[order(malaria$pid, malaria$pday),]
rm(sampled_pids)
```

# Data Cleaning

```{r}
unique(malaria$Studyyear) # all 2003, can drop it!
unique(malaria$country) # all Mozambique, so can drop it!

# remove Studyyear, country, Hb, pardens, gamedens, PIoutcome, PIoutcomeday
malaria <- malaria %>% select(-c(Studyyear, country, Hb, pardens, gamedens, PIoutcome, PIoutcomeday))

# what columns are left
colnames(malaria)

# how many subjects per site?
malaria %>%
  distinct(pid, site) %>%     # ensure one row per subject–site
  count(site, name = "n_subjects")

# collapse the sites to north and south regions
malaria <- malaria %>%
  mutate(region = case_when(
    site %in% c("Namaacha","Catuane","Boane") ~ "South",
    site == "Magude" ~ "North",
    TRUE ~ as.character(site)   # fallback in case of other sites
  ))
# drop site
malaria <- malaria %>% select(-site)

# missing values in responses: 
colSums(is.na(malaria))

# create two datasets for each drug (remove all NA rows of that drug):
pyr_df  <- subset(malaria, !is.na(Pyrconcentration))
sulf_df <- subset(malaria, !is.na(Sulfconcentration))


# remove patients who have an increase in drug concentration after day 3
pyr_bad_ids <- pyr_df %>%
  filter(pday > 3) %>%
  group_by(pid) %>%
  arrange(pday) %>%
  summarise(any_increase = any(diff(Pyrconcentration) > 0, na.rm = TRUE)) %>%
  filter(any_increase) %>%
  pull(pid)

# Drop those patients
pyr_df <- pyr_df %>%
  filter(!pid %in% pyr_bad_ids)

# repeat for sulf
sulf_bad_ids <- sulf_df %>%
  filter(pday > 3) %>%
  group_by(pid) %>%
  arrange(pday) %>%
  summarise(any_increase = any(diff(Sulfconcentration) > 0, na.rm = TRUE)) %>%
  filter(any_increase) %>%
  pull(pid)

# Drop those patients
sulf_df <- sulf_df %>%
  filter(!pid %in% sulf_bad_ids)

# create grouped data:
pyr_gd <- groupedData(Pyrconcentration ~ pday | pid,
                      data  = pyr_df,
                      outer = ~ arm)

sulf_gd <- groupedData(Sulfconcentration ~ pday | pid,
                       data  = sulf_df,
                       outer = ~ arm)

# create correct data types, center and scale covariates
for(df in c("pyr_df","sulf_df")){
  tmp <- get(df)
  tmp$pid    <- factor(tmp$pid)
  tmp$arm    <- factor(tmp$arm)           # consider setting baseline level = "SP"
  tmp$gender <- factor(tmp$gender)
  tmp$region <- factor(tmp$region)
  tmp$pday   <- as.numeric(tmp$pday)

  # center/scale continuous covariates (optional but helpful)
  tmp$c_weight <- scale(tmp$weight, center=TRUE, scale=FALSE)
  tmp$c_age    <- scale(tmp$age,    center=TRUE, scale=FALSE)

  assign(df, tmp)
}
```

# EDA

## Correlation checks

```{r}
# correlation between age and weight
cor(pyr_df$age, pyr_df$weight, use="complete.obs") # very high
cor(sulf_df$age, sulf_df$weight, use="complete.obs") # very high
```

## Specific questions

```{r}
# number of patients within each dataset
length(unique(pyr_df$pid)) # 245
length(unique(sulf_df$pid)) # 259
length(unique(malaria$pid)) # 306
```

```{r}
# are age and weight constant within patient?
df_age_weight <- malaria %>%
  group_by(pid) %>%
  summarise(
    n_age = n_distinct(age),
    n_weight = n_distinct(weight)
  ) %>%
  # filter for only records where either age or weight has > 1 distinct values
  filter(n_age > 1 | n_weight > 1)
# empty data frame, thus age and weight are constant within patient
rm(df_age_weight)
```

## Distribution of continuous covariates between regions and arm

```{r}
# begin by summarising the data at pid level
# Subject-level reductions
subjects <- malaria %>%
  arrange(pid, pday) %>%
  group_by(pid) %>%
  summarise(
    arm     = dplyr::first(na.omit(arm)),
    region  = dplyr::first(na.omit(region)),
    gender  = dplyr::first(na.omit(gender)),
    age     = dplyr::first(na.omit(age)),  
    weight  = dplyr::first(na.omit(weight)),
    .groups = "drop"
  )
```

```{r}
# summarise age by region and arm
var_to_plot <- "age"

# Boxplots/violin by arm within each region
p_age <- ggplot(subjects, aes(x = arm, y = .data[[var_to_plot]], fill = arm)) +
  geom_violin(trim = FALSE, alpha = 0.25, na.rm = TRUE, color = NA) +
  geom_boxplot(width = 0.2, outlier.shape = 21, na.rm = TRUE) +
  facet_wrap(~ region, scales = "fixed") +
  labs(x = "Arm", y = var_to_plot, title = paste("Distribution of", var_to_plot, "by Arm within Region")) +
  theme_bw() + theme(legend.position = "none")

ggsave("plots/age_dbn.pdf", plot = p_age, width = 5, height = 3)
```

```{r}
var_to_plot <- "weight"

# Boxplots/violin by arm within each region
p_weight <- ggplot(subjects, aes(x = arm, y = .data[[var_to_plot]], fill = arm)) +
  geom_violin(trim = FALSE, alpha = 0.25, na.rm = TRUE, color = NA) +
  geom_boxplot(width = 0.2, outlier.shape = 21, na.rm = TRUE) +
  facet_wrap(~ region, scales = "fixed") +
  labs(x = "Arm", y = var_to_plot, title = paste("Distribution of", var_to_plot, "by Arm within Region")) +
  theme_bw() + theme(legend.position = "none")

ggsave("plots/weight_dbn.pdf", plot = p_weight, width = 5, height = 3)
```

## Dropout rate: pyr

```{r}
# time on study/ dropout pattern
last_obs_pyr <- malaria %>%
  filter(!is.na(Pyrconcentration)) %>%                 # only rows where Pyr is observed
  group_by(pid) %>%
  summarise(
    last_pday = max(pday),               # last day observed for that pid
    n_obs     = n(),                     # how many Pyr measurements they have
    .groups = "drop"
  )

subjects <- malaria %>% distinct(pid, arm, region)

# counts of last observed day by arm
last_by_arm_pyr <- last_obs_pyr %>%
  left_join(subjects, by = "pid") %>%
  count(arm, last_pday, name = "n_subjects") %>%
  tidyr::pivot_wider(names_from = arm, values_from = n_subjects, values_fill = 0)

unique_days <- sort(unique(malaria$pday))

retention <- dplyr::bind_rows(lapply(unique_days, function(d) {
  last_obs_pyr %>%
    left_join(subjects, by = "pid") %>%
    group_by(arm) %>%
    summarise(n_at_least_d = sum(!is.na(last_pday) & last_pday >= d), .groups = "drop") %>%
    mutate(pday = d)
}))


p_ret_pyr <- ggplot(retention, aes(x = pday, y = n_at_least_d, color = arm)) +
   geom_line(linewidth = 1) + 
  geom_point() +
   labs(y = "Subjects with observed ≥ day", title = "Retention over time by Arm (Pyrimethamine)")+
  theme_bw()
ggsave("plots/retention_arm_pyr.pdf", plot = p_ret_pyr, height = 3, width = 5)
```


```{r}
# retention by region
last_obs <- malaria %>%
  filter(!is.na(Pyrconcentration)) %>%
  group_by(pid) %>%
  summarise(last_pday = max(pday), .groups = "drop")

# attach region info
subjects <- malaria %>% distinct(pid, region)
last_obs <- left_join(last_obs, subjects, by = "pid")

unique_days <- sort(unique(malaria$pday))

retention_region <- bind_rows(lapply(unique_days, function(d) {
  last_obs %>%
    group_by(region) %>%
    summarise(
      n_at_least_d = sum(!is.na(last_pday) & last_pday >= d),
      .groups = "drop"
    ) %>%
    mutate(pday = d)
}))

p_ret_reg <- ggplot(retention_region, aes(x = pday, y = n_at_least_d, color = region)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    x = "Day",
    y = "Subjects with observed ≥ day",
    title = "Retention over time by Region (Pyrimethamine)"
  ) +
  theme_bw()
ggsave("plots/retention_region_pyr.pdf", plot = p_ret_reg, width = 5, height = 3)
```


## Dropout rate: sulf

```{r}
# time on study/ dropout pattern
last_obs_sulf <- malaria %>%
  filter(!is.na(Sulfconcentration)) %>%                 # only rows where Sulf is observed
  group_by(pid) %>%
  summarise(
    last_pday = max(pday),               # last day observed for that pid
    n_obs     = n(),                     # how many Sulf measurements they have
    .groups = "drop"
  )

subjects <- malaria %>% distinct(pid, arm, region)

# counts of last observed day by arm
last_by_arm_sulf <- last_obs_sulf %>%
  left_join(subjects, by = "pid") %>%
  count(arm, last_pday, name = "n_subjects") %>%
  tidyr::pivot_wider(names_from = arm, values_from = n_subjects, values_fill = 0)

unique_days <- sort(unique(malaria$pday))

retention <- dplyr::bind_rows(lapply(unique_days, function(d) {
  last_obs_sulf %>%
    left_join(subjects, by = "pid") %>%
    group_by(arm) %>%
    summarise(n_at_least_d = sum(!is.na(last_pday) & last_pday >= d), .groups = "drop") %>%
    mutate(pday = d)
}))


p_ret_sulf <- ggplot(retention, aes(x = pday, y = n_at_least_d, color = arm)) +
   geom_line(linewidth = 1) + 
  geom_point() +
   labs(y = "Subjects with observed ≥ day", title = "Retention over time by Arm (Sulfadoxine)")+
  theme_bw()
ggsave("plots/retention_arm_sulf.pdf", plot = p_ret_pyr, height = 3, width = 5)
```


```{r}
# retention by region
last_obs <- malaria %>%
  filter(!is.na(Sulfconcentration)) %>%
  group_by(pid) %>%
  summarise(last_pday = max(pday), .groups = "drop")

# attach region info
subjects <- malaria %>% distinct(pid, region)
last_obs <- left_join(last_obs, subjects, by = "pid")

unique_days <- sort(unique(malaria$pday))

retention_region <- bind_rows(lapply(unique_days, function(d) {
  last_obs %>%
    group_by(region) %>%
    summarise(
      n_at_least_d = sum(!is.na(last_pday) & last_pday >= d),
      .groups = "drop"
    ) %>%
    mutate(pday = d)
}))

p_ret_reg <- ggplot(retention_region, aes(x = pday, y = n_at_least_d, color = region)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    x = "Day",
    y = "Subjects with observed ≥ day",
    title = "Retention over time by Region (Sulfadoxine)"
  ) +
  theme_bw()
ggsave("plots/retention_region_sulf.pdf", plot = p_ret_reg, width = 5, height = 3)
```

## Pyr dataset questions

```{r}
# gender: are the males and females balanced?
pyr_df %>%
  distinct(pid, gender) %>%   
  filter(gender == "F") %>%
  summarise(n_females = n())
# 156 of 245, roughly 64%
```

```{r}
# arm: are the treatments balanced?
pyr_df %>%
  distinct(pid, arm) %>%   
  filter(arm == "SP") %>%
  summarise(n_SP = n())
# 119 out of 245 is SP, thus roughly balanced according to treatment
```

```{r}
# do both regions offer both treatments?
pyr_df %>%
  group_by(region, arm) %>%
  summarise(n_unique_pid = n_distinct(pid), .groups = "drop")
# roughly balanced between regions
```

## Sulf dataset questions

```{r}
# gender: are the males and females balanced?
sulf_df %>%
  distinct(pid, gender) %>%   
  filter(gender == "F") %>%
  summarise(n_females = n())
# 157 of 259, roughly 60%
```

```{r}
# arm: are the treatments balanced?
sulf_df %>%
  distinct(pid, arm) %>%   
  filter(arm == "SP") %>%
  summarise(n_SP = n())
# 130 out of 259 is SP, thus roughly balanced according to treatment
```

```{r}
# do both regions offer both treatments?
sulf_df %>%
  group_by(region, arm) %>%
  summarise(n_unique_pid = n_distinct(pid), .groups = "drop")
# roughly balanced between regions
```

## Subject profiles

```{r}
## plot scatterplot of drug concentrations:
pyr_df$arm <- as.factor(pyr_df$arm)
sulf_df$arm <- as.factor(sulf_df$arm)

#pdf("plots/scatter_drug_time.pdf", height = 4, width = 7)
#op <- par(mfrow = c(1,2))
#with(pyr_df,  plot(pday, Pyrconcentration,  pch = 16, cex = .6, col = as.integer(arm),
#                   main = "Pyrimethamine (raw)", xlab = "Day", ylab = #"Concentration"))
#legend("topright", legend = levels(pyr_df$arm), pch = 16, col = #seq_along(levels(pyr_df$arm)), bty = "n")

#with(sulf_df, plot(pday, Sulfconcentration, pch = 16, cex = .6, col = as.integer(arm),
#                   main = "Sulfadoxine (raw)", xlab = "Day", ylab = "Concentration"))
#legend("topright", legend = levels(sulf_df$arm), pch = 16, col = seq_along(levels(sulf_df$arm)), bty = "n")
#par(op)
#dev.off()

## plot spaghetti plots of drug concentrations:
# Pyrimethamine
g_pyr <- ggplot(pyr_df, aes(pday, Pyrconcentration, group = pid, colour = arm)) +
  geom_line(alpha = 0.25, linewidth = 0.4) +
  facet_wrap(~ arm, nrow = 1) +
  labs(title = "Pyrimethamine concentration on the original scale",
       x = "Day", y = "Concentration") +
  theme_minimal() + 
  theme(legend.position = "none")
ggsave("plots/pyr_time.pdf", plot = g_pyr, width = 6, height = 3)

# Sulfadoxine
g_sulf <- ggplot(sulf_df, aes(pday, Sulfconcentration, group = pid, colour = arm)) +
  geom_line(alpha = 0.25, linewidth = 0.4) +
  facet_wrap(~ arm, nrow = 1) +
  labs(title = "Sulfadoxine concentration on the original scale",
       x = "Day", y = "Concentration") +
  theme_minimal() + 
  theme(legend.position = "none")
ggsave("plots/sulf_time.pdf", plot = g_sulf, width = 6, height = 3)
```

```{r}
rm(g_pyr)
rm(g_sulf)
rm(last_by_arm_pyr)
rm(last_by_arm_sulf)
rm(last_obs)
rm(last_obs_pyr)
rm(last_obs_sulf)
rm(p_age)
rm(p_ret_pyr)
rm(p_ret_reg)
rm(p_ret_sulf)
rm(p_weight)
rm(retention)
rm(retention_region)
rm(subjects)
rm(tmp)
rm(df)
rm(pyr_bad_ids)
rm(sulf_bad_ids)
rm(unique_days)
rm(var_to_plot)
```


# Model fitting: Pyr

## Fit individual models

```{r}
#  since we don't have a dose, we can just make the dose the same for everyone
pyr_df$Dose_Pyr <- 1 
# drop the all rows with NA in weight column:
pyr_df_cc <- subset(as.data.frame(pyr_df), !is.na(weight))

pyr_gd <- groupedData(Pyrconcentration ~ pday | pid, data = pyr_df_cc)

pyr_nls <- nlsList(
  Pyrconcentration ~ SSfol(Dose_Pyr, pday, lKe, lKa, lCl),
  data     = pyr_gd,
  na.action = na.omit,
  control  = nls.control(maxiter = 100, warnOnly = TRUE)
)
```


```{r}
# plot the confidence intervals of the estimates
out <- summary(pyr_nls)

cf_wide <- as.data.frame(out$coefficients)
# drop all NA:
cf_wide_noNA <- cf_wide[complete.cases(cf_wide), ]
pid <- rownames(cf_wide_noNA)

# Helper to build a tidy df and plot for one parameter
plot_param_ci <- function(df, est_col, se_col, title) {
  d <- tibble(
    pid    = rownames(df),
    est    = df[[est_col]],
    se     = df[[se_col]]
  ) %>%
    mutate(
      lower = est - 1.96 * se,
      upper = est + 1.96 * se,
      width = upper - lower
    ) %>%
    arrange(desc(width))     # sort from widest to narrowest
  
  # Drop the top 20 widest
  if (nrow(d) > 20) {
    d <- d[-(1:20), ]
  }
  
  ggplot(d, aes(x = reorder(pid, est), y = est, ymin = lower, ymax = upper)) +
    geom_pointrange() +
    coord_flip() +
    theme_bw() +
    labs(x = "Subject (pid)", y = "Estimate ± 95% CI", title = title)
}


# 1) lKe
p_lKe <- plot_param_ci(cf_wide_noNA, "Estimate.lKe", "Std. Error.lKe", "lKe: per-subject estimates with 95% CI")
p_lKe

# 2) lKa
p_lKa <- plot_param_ci(cf_wide_noNA, "Estimate.lKa", "Std. Error.lKa", "lKa: per-subject estimates with 95% CI")
p_lKa

# 3) lCl
p_lCl <- plot_param_ci(cf_wide_noNA, "Estimate.lCl", "Std. Error.lCl", "lCl: per-subject estimates with 95% CI")
p_lCl

```

## Fit a basic nlme model

Now fit an nlme.

```{r}
pyr_nlme_base <- nlme(pyr_nls,                       
  random  = pdDiag(lKe + lKa ~ 1),
  method  = "REML"
)

# note the following causes convergence issues 
#try <- nlme(pyr_nls,
     #       random = lKe + lKa ~1,
      #      method = "REML")
# running lKa, lCl and lKe did not converge
# removing lKa lead to singularities
# removing lCl lead to immediate convergence
# removing lKe still did not converge

m0_REML <- pyr_nlme_base

summary(m0_REML) # these look ok
VarCorr(m0_REML) # some are almost zero

## residual diagnostics
par(mfrow = c(2,2))
plot(m0_REML)   # residuals vs fitted by id
qqnorm(m0_REML, ~ resid(.))  # residual normality, no clear fan shape
plot(augPred(m0_REML), layout = c(4,4), pages = 1)  # quick VPC 
par(mfrow = c(1,1))

## quick checks for heteroscedasticity / time pattern
res <- resid(m0_REML, type = "pearson")
fit <- fitted(m0_REML)
plot(fit, res); abline(h = 0, lty = 2) # fan-shape?
plot(pyr_gd$pday, res); abline(h = 0, lty = 2) # serial pattern?
```
We're going to make 2 changes:
1. Switch to ML to be able to run likelihood ratio tests
2. Remove lKa from the random effects due to tiny variance estimation (meaning it may be too complex for ML to evaluate with that included)

```{r}
m1_ML <- update(
  pyr_nlme_base,
  method = "ML",
  random = lKe ~ 1   # drop lKa RE; keep lKe RE only
)
summary(m1_ML)
VarCorr(m1_ML) # the large residuals is apparently typical for PK data
```

## Adding covariates

We will do some EDA to determine which covariates to test.

- Currently the fixed effects are: fixed = lKe + lKa + lCl ~ 1.

### EDA

First, prepare the dataset.
```{r}
# Data used in the model
df <- as.data.frame(pyr_gd)

# Observation-level diagnostics
df$fit  <- fitted(m1_ML,  level = 1)
df$res  <- resid(m1_ML,   type = "pearson", level = 1)

# Subject-level random effects (EBE) for lKe
re  <- ranef(m1_ML) %>% tibble::rownames_to_column("pid")
colnames(re)[2] <- "b_lKe"   # rename the single RE column

# Join EBEs back to each row (or keep subject-only in later steps)
df  <- df %>% left_join(re, by = "pid")
```

Residuals vs fitted & time

```{r}
# residuals vs fitted
ggplot(df, aes(fit, res)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "Residuals vs Fitted", x = "Fitted", y = "Pearson residual")
# weird shape

# residuals vs time (pday)
ggplot(df, aes(pday, res)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "Residuals vs Time", x = "pday", y = "Pearson residual")
# larger variation at the start than the end

# residual QQ plot
qqnorm(resid(m1_ML, type = "normalized")); qqline(resid(m1_ML, type = "normalized"))
## large deviations at tails
```

Residuals vs continuous covariates (weight and age)

```{r}
# Weight (centered)
ggplot(df, aes(c_weight, res)) +
  geom_point(alpha = 0.5) + geom_smooth(se = FALSE) +
  labs(title = "Residuals vs c_weight")

# Age (centered)
ggplot(df, aes(c_age, res)) +
  geom_point(alpha = 0.5) + geom_smooth(se = FALSE) +
  labs(title = "Residuals vs c_age")

# neither of these show systematic increase in residuals as covariate increase or any other pattern- not include
```

Now test categorical covariates

```{r}
# Ensure factors
df <- df %>%
  mutate(
    gender = factor(gender),
    arm    = factor(arm),
    region = factor(region)
  )

# Boxplots by category (skip if var absent)
ggplot(df, aes(gender, res)) + geom_boxplot() + labs(title = "Residuals by gender")
# very tight boxplots with some potential outliers for females

ggplot(df, aes(arm, res)) + geom_boxplot() + labs(title = "Residuals by arm") # again very tight, potentially outliers

ggplot(df, aes(region, res)) + geom_boxplot() + labs(title = "Residuals by region") # same as above
```
Now look at random effects (at subject level) vs covariates

```{r}
# collapse to subject-level covariates (first non-missing per pid)
subj <- df %>%
  group_by(pid) %>%
  summarise(
    b_lKe   = dplyr::first(b_lKe),
    weight  = dplyr::first(na.omit(weight)),
    c_weight= dplyr::first(na.omit(c_weight)),
    age     = dplyr::first(na.omit(age)),
    c_age   = dplyr::first(na.omit(c_age)),
    gender  = dplyr::first(gender),
    arm     = dplyr::first(arm),
    region  = dplyr::first(region),
    .groups = "drop"
  )

# b_lKe vs continuous covariates
ggplot(subj, aes(c_weight, b_lKe)) +
  geom_point() + geom_smooth(se = FALSE) +
  labs(title = "Subject RE (lKe) vs c_weight") # some curve!

ggplot(subj, aes(c_age, b_lKe)) +
  geom_point() + geom_smooth(se = FALSE) +
  labs(title = "Subject RE (lKe) vs c_age") # also some pattern

# b_lKe by categorical covariates
ggplot(subj, aes(gender, b_lKe)) + geom_boxplot() +
  labs(title = "Subject RE (lKe) by gender") # nothing really..

ggplot(subj, aes(arm, b_lKe)) + geom_boxplot() +
  labs(title = "Subject RE (lKe) by arm") # nothing really..

ggplot(subj, aes(region, b_lKe)) + geom_boxplot() +
  labs(title = "Subject RE (lKe) by region") # nothing really..
```

### Adding age and weight

The only noticible interesting trends are for age and weight. So we will try to add these.

- We can add weight as a fixed effect on lKe (our only random effect). Recall in this case that we are estimating the following parameters: lKe, lKa and lCl. We now want to specify how the covariates influence these parameters. So we do it as below to essentially say there is a population mean for lKe (~1, plus a slope on the weight)

```{r}
# Use centered weight
# Intercepts from the converged base ML model (order: lKe, lKa, lCl)
# get current fixed-effect starts (order: lKe, lKa, lCl)
beta0 <- unname(fixef(m1_ML))

# add linear + quadratic weight on lKe
m2w_ML <- update(
  m1_ML,
  fixed = list(
    lKe ~ 1 + c_weight + I(c_weight^2),
    lKa ~ 1,
    lCl ~ 1
  ),
  # starts: lKe_intercept, lKe_c_weight, lKe_c_weight^2, lKa_intercept, lCl_intercept
  start = c(beta0[1], 0, 0, beta0[2], beta0[3])
)

# compare
anova(m1_ML, m2w_ML) # highly significant
summary(m2w_ML)
```
Now let's do age:

```{r}
# Add linear + quadratic age on lKe
m2a_ML <- update(
  m1_ML,
  fixed = list(
    lKe ~ 1 + c_age + I(c_age^2),
    lKa ~ 1,
    lCl ~ 1
  ),
  # start vector: lKe_intercept, lKe:c_age, lKe:c_age^2, lKa_intercept, lCl_intercept
  start = c(beta0[1], 0, 0, beta0[2], beta0[3])
)

# Likelihood ratio test vs base
anova(m1_ML, m2a_ML) # also significant
summary(m2a_ML)
```

Now let's combine both into the same model.

```{r}
beta0 <- unname(fixef(m1_ML))

m3_ML <- update(
  m1_ML,
  fixed = list(
    lKe ~ 1 + c_weight + I(c_weight^2) + c_age + I(c_age^2),
    lKa ~ 1,
    lCl ~ 1
  ),
  # intercept, weight slope, weight^2, age slope, age^2, lKa intercept, lCl intercept
  start = c(beta0[1], 0, 0, 0, 0, beta0[2], beta0[3])
)

anova(m1_ML, m3_ML)   # very significant.
summary(m3_ML) # which are individually significant:
## only I(c_age^2) does not seem significant

VarCorr(m3_ML) # variance of lKe got smaller since we explained part of it.
VarCorr(m1_ML)
```
Let's drop age^2:

```{r}
m4_ML <- update(
  m1_ML,
  fixed = list(
    lKe ~ 1 + c_weight + I(c_weight^2) + c_age,
    lKa ~ 1,
    lCl ~ 1
  ),
  # start vector: intercept, weight slope, weight^2, age slope, lKa intercept, lCl intercept
  start = c(beta0[1], 0, 0, 0, beta0[2], beta0[3])
)

anova(m1_ML, m4_ML)   # compare vs base: highly significant
anova(m3_ML, m4_ML)   # adding age^2 doesn't improve fit
summary(m4_ML) # all are sigificant now
VarCorr(m4_ML) # variance still shrunk for lKe
```
Now refit with REML.

```{r}
m_final <- update(m4_ML, method = "REML")
summary(m_final)
VarCorr(m_final) # no negative variances, residual var increased, but variance of lKe decreased
VarCorr(m1_ML)
```
Let's check diagnostics again:
```{r}
res <- resid(m_final, type = "normalized")  

# Residual plots
par(mfrow = c(1,2))
plot(m_final)  # residuals vs fitted
qqnorm(res, main = "QQ plot of residuals")
qqline(res, col = "red", lwd = 2) 
par(mfrow = c(1,1))

hist(res, breaks = 20, prob = TRUE,
     main = "Histogram of residuals", xlab = "Residuals")
lines(density(res), col = "blue", lwd = 2)

# Random effects (BLUPs) vs covariates
re <- ranef(m_final)
qqnorm(re[,1], main = "QQ plot of random effect (lKe)")
qqline(re, col = "red", lwd = 2)
hist(re[,1], breaks = 15, prob = TRUE,
     main = "Histogram of random effect (lKe)", xlab = "lKe")
lines(density(re[,1]), col = "blue", lwd = 2)
```


Would changing the variance function help?

