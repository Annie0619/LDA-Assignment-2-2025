---
title: "Longitudinal Data Analysis Assignment 2"
author: "Andomei Smit: SMTAND051"
date: "01/09/2025"
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 2
    fig_caption: true
    keep_tex: true
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
library(nlme)
library(faraway)
library(lattice)
library(dplyr)
library(ggplot2)
library(tidyr)
library(MuMIn)
```

# Introduction

```{r}
# read in the data
malaria <- read.csv("malariadata.csv")
#head(malaria)

# random sample carefully so that records stay complete
set.seed(1997)
# sample 75% of unique pids
sampled_pids <- malaria %>%
  distinct(pid) %>%
  slice_sample(prop = 0.75) %>%
  pull(pid)

# keep all rows for those pids
malaria <- malaria %>% semi_join(tibble(pid = sampled_pids), by = "pid")

# order malaria by pid
malaria <- malaria[order(malaria$pid, malaria$pday),]
rm(sampled_pids)
```

# Data Cleaning

```{r}
unique(malaria$Studyyear) # all 2003, can drop it!
unique(malaria$country) # all Mozambique, so can drop it!

# remove Studyyear, country, Hb, pardens, gamedens, PIoutcome, PIoutcomeday
malaria <- malaria %>% select(-c(Studyyear, country, Hb, pardens, gamedens, PIoutcome, PIoutcomeday))

# what columns are left
colnames(malaria)

# how many subjects per site?
malaria %>%
  distinct(pid, site) %>%     # ensure one row per subject–site
  count(site, name = "n_subjects")

# collapse the sites to north and south regions
malaria <- malaria %>%
  mutate(region = case_when(
    site %in% c("Namaacha","Catuane","Boane") ~ "South",
    site == "Magude" ~ "North",
    TRUE ~ as.character(site)   # fallback in case of other sites
  ))
# drop site
malaria <- malaria %>% select(-site)

# missing values in responses: 
colSums(is.na(malaria))

# create two datasets for each drug (remove all NA rows of that drug):
pyr_df  <- subset(malaria, !is.na(Pyrconcentration))
sulf_df <- subset(malaria, !is.na(Sulfconcentration))


# remove patients who have an increase in drug concentration after day 3
pyr_bad_ids <- pyr_df %>%
  filter(pday > 3) %>%
  group_by(pid) %>%
  arrange(pday) %>%
  summarise(any_increase = any(diff(Pyrconcentration) > 0, na.rm = TRUE)) %>%
  filter(any_increase) %>%
  pull(pid)

# Drop those patients
pyr_df_clean <- pyr_df %>%
  filter(!pid %in% pyr_bad_ids)

# repeat for sulf
sulf_bad_ids <- sulf_df %>%
  filter(pday > 3) %>%
  group_by(pid) %>%
  arrange(pday) %>%
  summarise(any_increase = any(diff(Sulfconcentration) > 0, na.rm = TRUE)) %>%
  filter(any_increase) %>%
  pull(pid)

# Drop those patients
sulf_df_clean <- sulf_df %>%
  filter(!pid %in% sulf_bad_ids)

# create grouped data:
pyr_gd <- groupedData(Pyrconcentration ~ pday | region/pid,
                      data  = pyr_df,
                      outer = ~ arm)

sulf_gd <- groupedData(Sulfconcentration ~ pday | region/pid,
                       data  = sulf_df,
                       outer = ~ arm)

# create correct data types, center and scale covariates
for(df in c("pyr_df","sulf_df")){
  tmp <- get(df)
  tmp$pid    <- factor(tmp$pid)
  tmp$arm    <- factor(tmp$arm)           # consider setting baseline level = "SP"
  tmp$gender <- factor(tmp$gender)
  tmp$region <- factor(tmp$region)
  tmp$pday   <- as.numeric(tmp$pday)

  # center/scale continuous covariates (optional but helpful)
  tmp$c_weight <- scale(tmp$weight, center=TRUE, scale=FALSE)
  tmp$c_age    <- scale(tmp$age,    center=TRUE, scale=FALSE)

  assign(df, tmp)
}
```

# EDA

## Correlation checks

```{r}
# correlation between age and weight
cor(pyr_df_clean$age, pyr_df_clean$weight, use="complete.obs") # very high
cor(sulf_df_clean$age, sulf_df_clean$weight, use="complete.obs") # very high
```

## Specific questions

```{r}
# number of patients within each dataset
length(unique(pyr_df_clean$pid)) # 245
length(unique(sulf_df_clean$pid)) # 259
length(unique(malaria$pid)) # 306
```

```{r}
# are age and weight constant within patient?
df_age_weight <- malaria %>%
  group_by(pid) %>%
  summarise(
    n_age = n_distinct(age),
    n_weight = n_distinct(weight)
  ) %>%
  # filter for only records where either age or weight has > 1 distinct values
  filter(n_age > 1 | n_weight > 1)
# empty data frame, thus age and weight are constant within patient
rm(df_age_weight)
```

## Distribution of continuous covariates between regions and arm

```{r}
# begin by summarising the data at pid level
# Subject-level reductions
subjects <- malaria %>%
  arrange(pid, pday) %>%
  group_by(pid) %>%
  summarise(
    arm     = dplyr::first(na.omit(arm)),
    region  = dplyr::first(na.omit(region)),
    gender  = dplyr::first(na.omit(gender)),
    age     = dplyr::first(na.omit(age)),  
    weight  = dplyr::first(na.omit(weight)),
    .groups = "drop"
  )
```

```{r}
# summarise age by region and arm
var_to_plot <- "age"

# Boxplots/violin by arm within each region
p_age <- ggplot(subjects, aes(x = arm, y = .data[[var_to_plot]], fill = arm)) +
  geom_violin(trim = FALSE, alpha = 0.25, na.rm = TRUE, color = NA) +
  geom_boxplot(width = 0.2, outlier.shape = 21, na.rm = TRUE) +
  facet_wrap(~ region, scales = "fixed") +
  labs(x = "Arm", y = var_to_plot, title = paste("Distribution of", var_to_plot, "by Arm within Region")) +
  theme_bw() + theme(legend.position = "none")

ggsave("plots/age_dbn.pdf", plot = p_age, width = 5, height = 3)
```

```{r}
var_to_plot <- "weight"

# Boxplots/violin by arm within each region
p_weight <- ggplot(subjects, aes(x = arm, y = .data[[var_to_plot]], fill = arm)) +
  geom_violin(trim = FALSE, alpha = 0.25, na.rm = TRUE, color = NA) +
  geom_boxplot(width = 0.2, outlier.shape = 21, na.rm = TRUE) +
  facet_wrap(~ region, scales = "fixed") +
  labs(x = "Arm", y = var_to_plot, title = paste("Distribution of", var_to_plot, "by Arm within Region")) +
  theme_bw() + theme(legend.position = "none")

ggsave("plots/weight_dbn.pdf", plot = p_weight, width = 5, height = 3)
```

## Dropout rate: pyr

```{r}
# time on study/ dropout pattern
last_obs_pyr <- malaria %>%
  filter(!is.na(Pyrconcentration)) %>%                 # only rows where Pyr is observed
  group_by(pid) %>%
  summarise(
    last_pday = max(pday),               # last day observed for that pid
    n_obs     = n(),                     # how many Pyr measurements they have
    .groups = "drop"
  )

subjects <- malaria %>% distinct(pid, arm, region)

# counts of last observed day by arm
last_by_arm_pyr <- last_obs_pyr %>%
  left_join(subjects, by = "pid") %>%
  count(arm, last_pday, name = "n_subjects") %>%
  tidyr::pivot_wider(names_from = arm, values_from = n_subjects, values_fill = 0)

unique_days <- sort(unique(malaria$pday))

retention <- dplyr::bind_rows(lapply(unique_days, function(d) {
  last_obs_pyr %>%
    left_join(subjects, by = "pid") %>%
    group_by(arm) %>%
    summarise(n_at_least_d = sum(!is.na(last_pday) & last_pday >= d), .groups = "drop") %>%
    mutate(pday = d)
}))


p_ret_pyr <- ggplot(retention, aes(x = pday, y = n_at_least_d, color = arm)) +
   geom_line(linewidth = 1) + 
  geom_point() +
   labs(y = "Subjects with observed ≥ day", title = "Retention over time by Arm (Pyrimethamine)")+
  theme_bw()
ggsave("plots/retention_arm_pyr.pdf", plot = p_ret_pyr, height = 3, width = 5)
```


```{r}
# retention by region
last_obs <- malaria %>%
  filter(!is.na(Pyrconcentration)) %>%
  group_by(pid) %>%
  summarise(last_pday = max(pday), .groups = "drop")

# attach region info
subjects <- malaria %>% distinct(pid, region)
last_obs <- left_join(last_obs, subjects, by = "pid")

unique_days <- sort(unique(malaria$pday))

retention_region <- bind_rows(lapply(unique_days, function(d) {
  last_obs %>%
    group_by(region) %>%
    summarise(
      n_at_least_d = sum(!is.na(last_pday) & last_pday >= d),
      .groups = "drop"
    ) %>%
    mutate(pday = d)
}))

p_ret_reg <- ggplot(retention_region, aes(x = pday, y = n_at_least_d, color = region)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    x = "Day",
    y = "Subjects with observed ≥ day",
    title = "Retention over time by Region (Pyrimethamine)"
  ) +
  theme_bw()
ggsave("plots/retention_region_pyr.pdf", plot = p_ret_reg, width = 5, height = 3)
```


## Dropout rate: sulf

```{r}
# time on study/ dropout pattern
last_obs_sulf <- malaria %>%
  filter(!is.na(Sulfconcentration)) %>%                 # only rows where Sulf is observed
  group_by(pid) %>%
  summarise(
    last_pday = max(pday),               # last day observed for that pid
    n_obs     = n(),                     # how many Sulf measurements they have
    .groups = "drop"
  )

subjects <- malaria %>% distinct(pid, arm, region)

# counts of last observed day by arm
last_by_arm_sulf <- last_obs_sulf %>%
  left_join(subjects, by = "pid") %>%
  count(arm, last_pday, name = "n_subjects") %>%
  tidyr::pivot_wider(names_from = arm, values_from = n_subjects, values_fill = 0)

unique_days <- sort(unique(malaria$pday))

retention <- dplyr::bind_rows(lapply(unique_days, function(d) {
  last_obs_sulf %>%
    left_join(subjects, by = "pid") %>%
    group_by(arm) %>%
    summarise(n_at_least_d = sum(!is.na(last_pday) & last_pday >= d), .groups = "drop") %>%
    mutate(pday = d)
}))


p_ret_sulf <- ggplot(retention, aes(x = pday, y = n_at_least_d, color = arm)) +
   geom_line(linewidth = 1) + 
  geom_point() +
   labs(y = "Subjects with observed ≥ day", title = "Retention over time by Arm (Sulfadoxine)")+
  theme_bw()
ggsave("plots/retention_arm_sulf.pdf", plot = p_ret_pyr, height = 3, width = 5)
```


```{r}
# retention by region
last_obs <- malaria %>%
  filter(!is.na(Sulfconcentration)) %>%
  group_by(pid) %>%
  summarise(last_pday = max(pday), .groups = "drop")

# attach region info
subjects <- malaria %>% distinct(pid, region)
last_obs <- left_join(last_obs, subjects, by = "pid")

unique_days <- sort(unique(malaria$pday))

retention_region <- bind_rows(lapply(unique_days, function(d) {
  last_obs %>%
    group_by(region) %>%
    summarise(
      n_at_least_d = sum(!is.na(last_pday) & last_pday >= d),
      .groups = "drop"
    ) %>%
    mutate(pday = d)
}))

p_ret_reg <- ggplot(retention_region, aes(x = pday, y = n_at_least_d, color = region)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    x = "Day",
    y = "Subjects with observed ≥ day",
    title = "Retention over time by Region (Sulfadoxine)"
  ) +
  theme_bw()
ggsave("plots/retention_region_sulf.pdf", plot = p_ret_reg, width = 5, height = 3)
```

## Pyr dataset questions

```{r}
# gender: are the males and females balanced?
pyr_df_clean %>%
  distinct(pid, gender) %>%   
  filter(gender == "F") %>%
  summarise(n_females = n())
# 156 of 245, roughly 64%
```

```{r}
# arm: are the treatments balanced?
pyr_df_clean %>%
  distinct(pid, arm) %>%   
  filter(arm == "SP") %>%
  summarise(n_SP = n())
# 119 out of 245 is SP, thus roughly balanced according to treatment
```

```{r}
# do both regions offer both treatments?
pyr_df_clean %>%
  group_by(region, arm) %>%
  summarise(n_unique_pid = n_distinct(pid), .groups = "drop")
# roughly balanced between regions
```

## Sulf dataset questions

```{r}
# gender: are the males and females balanced?
sulf_df_clean %>%
  distinct(pid, gender) %>%   
  filter(gender == "F") %>%
  summarise(n_females = n())
# 157 of 259, roughly 60%
```

```{r}
# arm: are the treatments balanced?
sulf_df_clean %>%
  distinct(pid, arm) %>%   
  filter(arm == "SP") %>%
  summarise(n_SP = n())
# 130 out of 259 is SP, thus roughly balanced according to treatment
```

```{r}
# do both regions offer both treatments?
sulf_df_clean %>%
  group_by(region, arm) %>%
  summarise(n_unique_pid = n_distinct(pid), .groups = "drop")
# roughly balanced between regions
```

## Should we log transform the responses?

```{r}
## plot scatterplot of drug concentrations:
pdf("plots/scatter_drug_time.pdf", height = 4, width = 7)
op <- par(mfrow = c(1,2))
with(pyr_df,  plot(pday, Pyrconcentration,  pch = 16, cex = .6, col = as.integer(arm),
                   main = "Pyrimethamine (raw)", xlab = "Day", ylab = "Concentration"))
legend("topright", legend = levels(pyr_df$arm), pch = 16, col = seq_along(levels(pyr_df$arm)), bty = "n")

with(sulf_df, plot(pday, Sulfconcentration, pch = 16, cex = .6, col = as.integer(arm),
                   main = "Sulfadoxine (raw)", xlab = "Day", ylab = "Concentration"))
legend("topright", legend = levels(sulf_df$arm), pch = 16, col = seq_along(levels(sulf_df$arm)), bty = "n")
par(op)
dev.off()

## plot spaghetti plots of drug concentrations:
# Pyrimethamine
g_pyr <- ggplot(pyr_df_clean, aes(pday, Pyrconcentration, group = pid, colour = arm)) +
  geom_line(alpha = 0.25, linewidth = 0.4) +
  facet_wrap(~ arm, nrow = 1) +
  labs(title = "Pyrimethamine concentration on the original scale",
       x = "Day", y = "Concentration") +
  theme_minimal() + 
  theme(legend.position = "none")
ggsave("plots/pyr_time.pdf", plot = g_pyr, width = 6, height = 3)

# Sulfadoxine
g_sulf <- ggplot(sulf_df_clean, aes(pday, Sulfconcentration, group = pid, colour = arm)) +
  geom_line(alpha = 0.25, linewidth = 0.4) +
  facet_wrap(~ arm, nrow = 1) +
  labs(title = "Sulfadoxine concentration on the original scale",
       x = "Day", y = "Concentration") +
  theme_minimal() + 
  theme(legend.position = "none")
ggsave("plots/sulf_time.pdf", plot = g_sulf, width = 6, height = 3)
```

This pattern is very common in oral drug concentrations. There is an initial increase, then a sharp decline, followed by a steady decrease. This is known as a bi-phasic shape. For simplicity, we will begin by fitting an exponential function to model the decay. A biexponential could be more realistic- this is where two exponentials are fit to be able to account for the  difference in rates, but there may be identifiability issues, so we begin with the simpler model.

There seems to be a difference between the treatments in both the intercept and slope. There does seem to be a difference in slopes in the sphagetti plots. In the scatterplots there is also some separation.

There seems to be a difference in the spread of concentration levels. We may need to model residuals as being proportional to the concentration of the drug (i.e. fan out with the concentration). But we will first model errors as being constant, then check residuals vs fitted later on.

Now what if we log transform the variables. Let's look at the spaghetti plots on the log scale:

```{r}
# Pyrimethamine
g_pyr_log <- ggplot(pyr_df_clean, aes(pday, log(Pyrconcentration), group = pid, colour = arm)) +
  geom_line(alpha = 0.25, linewidth = 0.4) +
  facet_wrap(~ arm, nrow = 1) +
  labs(title = "Pyrimethamine concentration on the log scale",
       x = "Day", y = "log Concentration") +
  theme_minimal() +
  theme(legend.position = "none")
ggsave("plots/pyr_log.pdf", plot = g_pyr_log, width = 6, height = 3)

# Sulfadoxine
g_sulf_log <- ggplot(sulf_df_clean, aes(pday, log(Sulfconcentration), group = pid, colour = arm)) +
  geom_line(alpha = 0.25, linewidth = 0.4) +
  facet_wrap(~ arm, nrow = 1) +
  labs(title = "Sulfadoxine concentration on the log scale",
       x = "Day", y = "log Concentration") +
  theme_minimal() +
  theme(legend.position = "none")
ggsave("plots/sulf_log.pdf", plot = g_sulf_log, width = 6, height = 3)
```

We notice that these lines look relatively straight after the absorbtion phase, thus an exponential decay curve seems to be appropriate.
